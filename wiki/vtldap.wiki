#labels java,ldap,jndi
#sidebar vtldapSidebar

<wiki:toc max_depth="2" />

----
*Updating for 3.3 release*
----

= Introduction =
VT Ldap is a Java library for interfacing with version 3 LDAPs.
This library meets the following design goals:
 # Easy and flexible to configure. Configuration can be done with a properties file located on your classpath or via Spring.
 # Ease of use for common ldap operations. Searching, comparing, adding, and replacing all require only a few lines of code.
 # Automatic connection handling. Timed out connections automatically retry and TLS/SSL is negotiated transparently.
 # Support for sasl operations. Digest-MD5, CRAM-MD5, GSSAPI, and EXTERNAL are all supported.
 # Command line interface for common operations.

----
= Installation =
The latest version can be downloaded from the [http://code.google.com/p/vt-middleware/downloads/list downloads] page.

If you would like to use this project in your maven build, include the following in your pom.xml:
{{{
<dependencies>
  <dependency>
      <groupId>edu.vt.middleware</groupId>
      <artifactId>vt-ldap</artifactId>
      <version>3.3</version>
  </dependency>
<dependencies>
}}}
{{{
<repositories>
  <repository>
    <id>vt-middleware.repo</id>
    <url>http://vt-middleware.googlecode.com/svn/maven2</url>
  </repository>
</repositories>
}}}

----
= Code Samples =
Unless otherwise noted, classes appearing in the following samples are included in the JSE libraries or VT Ldap.

== Searching ==

=== Compare ===
Perform a compare on the entry 'uid=818037,ou=People,dc=vt,dc=edu', checking for an attribute value of 'mail=dfisher@vt.edu'
{{{
Ldap ldap = new Ldap(
  new LdapConfig("ldap://directory.vt.edu:389", "ou=People,dc=vt,dc=edu"));
if (ldap.compare("uid=818037,ou=People,dc=vt,dc=edu", new SearchFilter("mail=dfisher@vt.edu"))) {
  System.out.println("Compare succeeded");
} else {
  System.out.println("Compare failed");
}
ldap.close();
}}}
_Note that in order to perform a real LDAP compare operation, your filter must be of the form '(name=value)'. Any other type of filter, using expressions or wildcards, will results in an object level ldap search. This will produce the desired result, but implementers examining their LDAP logs may notice this discrepancy._

=== Subtree search ===
Perform a search for 'sn=Fisher' and output all attributes in LDIF format to System.out.
{{{
Ldap ldap = new Ldap(
  new LdapConfig("ldap://directory.vt.edu/dc=vt,dc=edu"));
(new Ldif()).outputLdif(
  ldap.search(new SearchFilter("sn=Fisher")),
  new BufferedWriter(new OutputStreamWriter(System.out)));
ldap.close();
}}}

=== Attribute search ===
Perform a search for all entries containing an attribute matching 'mail=dfisher@vt.edu', and output the attributes 'sn' and 'givenName' in DSMLv1 format to System.out.
{{{
Ldap ldap = new Ldap(
  new LdapConfig("ldap://directory.vt.edu", "ou=People,dc=vt,dc=edu"));
(new Dsmlv1()).outputDsml(
  ldap.searchAttributes(
    AttributesFactory.createAttributes("mail", "dfisher@vt.edu"),
    new String[]{"sn", "givenName"}),
  new BufferedWriter(new OutputStreamWriter(System.out)));
ldap.close();
}}}

== Authentication ==
Authenticate a user whose entry resides in the 'ou=People' branch of the ldap.
TLS is required for all connections and the username must equal the attribute value of the attributes 'uid' or 'mail'.
{{{
AuthenticatorConfig config = new AuthenticatorConfig(
  "ldap://authn.directory.vt.edu", "ou=People,dc=vt,dc=edu");
config.setTls(true);
config.setUserField(new String[]{"uid", "mail"}); // attribute to search for user with
Authenticator auth = new Authenticator(config);
if (auth.authenticate(user, credential)) {
  System.out.println("Authentication succeeded");
} else {
  System.out.println("Authentication failed");
}
}}}

Same example as above, but also authorize the user on 'eduPersonAffiliation'.
{{{
AuthenticatorConfig config = new AuthenticatorConfig(
  "ldap://authn.directory.vt.edu", "ou=People,dc=vt,dc=edu");
config.setTls(true);
config.setUserFilter("(|(uid={0})(mail={0}))"); // attribute to search for user with
Authenticator auth = new Authenticator(config);
if (auth.authenticate(user, credential, new SearchFilter("eduPersonAffiliation=staff"))) {
  System.out.println("Authentication/Authorization succeeded");
} else {
  System.out.println("Authentication/Authorization failed");
}
}}}

== Pooling ==
Create a new soft limit pool, accepting all the default configuration properties. Check a ldap object out from the pool, perform a search, and return the object to the pool.
{{{
DefaultLdapFactory factory = new DefaultLdapFactory(
  new LdapConfig("ldap://directory.vt.edu/ou=People,dc=vt,dc=edu"));
SoftLimitLdapPool pool = new SoftLimitLdapPool(factory);
pool.initialize();
Ldap ldap = null;
try {
  ldap = pool.checkOut();
  ...
  Iterator<SearchResult> i = ldap.search(
    new SearchFilter("givenName=Daniel"), new String[]{"uid", "mail"});
  ...
} catch (LdapPoolException e) {
  log.error("Error using the ldap pool.", e);
} finally {
  pool.checkIn(ldap);
}
...
pool.close();
}}}

----
= Configuration Properties =
The Ldap and Authenticator objects can be configured from a properties file.<br/>
This is useful for maintaining a ldap configuration outside of your source code.<br/>
Simply create a file called _ldap.properties_ and place it in your root classpath..
{{{
Ldap ldap = new Ldap();
ldap.loadFromProperties();
}}}
If you prefer to use a different filename and/or classpath location:
{{{
Ldap ldap = new Ldap();
ldap.loadFromProperties(MyClass.class.getResourceAsStream("/classpath/to/your/propertiesFile"));
}}}
If you prefer to use a system filepath:
{{{
Ldap ldap = new Ldap();
ldap.loadFromProperties(new FileInputStream("/path/to/your/propertiesFile"));
}}}

== Properties ==
Any property provided that does not match the following property names is placed directly into the JNDI context. This allows the user to provide ad-hoc environment properties.

=== Context Properties ===
Properties injected directly into the JNDI context.
|| *Property Name* || *Default Value* || *Description* ||
|| edu.vt.middleware.ldap.contextFactory || com.sun.jndi.ldap.LdapCtxFactory || fully qualified class name of the context factory that JNDI should use ||
|| edu.vt.middleware.ldap.sslSocketFactory || _none_ || fully qualified class name which implements javax.net.ssl.SSLSocketFactory; will be used for all TLS/SSL connections ||
|| edu.vt.middleware.ldap.hostnameVerifier || _none_ || fully qualified class name which implements javax.net.ssl.HostnameVerifier; will be used for all TLS connections ||
|| edu.vt.middleware.ldap.ldapUrl || _none_ || fully qualified URL to the ldap. e.g. ldap://directory.vt.edu:389. This property can also accept the base DN: ldap://directory.vt.edu:389/ou=People,dc=vt,dc=edu. (Note that this format should only be used for searching. If you will be performing updates or authentications, then including the base DN in the URL has the potential to cause problems.) ||
|| edu.vt.middleware.ldap.timeout || -1 || the amount of time in milliseconds that connect operations will block; a value of -1 means use the network timeout value ||
|| edu.vt.middleware.ldap.authoritative || false || whether authoritative responses are accepted from DNS servers ||
|| edu.vt.middleware.ldap.batchSize || -1 || the batch size to use when returning results; a value of -1 means use no batch size ||
|| edu.vt.middleware.ldap.dnsUrl || _none_ || the DNS url to use for hostname resolution ||
|| edu.vt.middleware.ldap.language || _none_ || the preferred language ||
|| edu.vt.middleware.ldap.referral || _none_ || specifies how referrals should be handled; must be one of 'throw', 'ignore', or 'follow' ||
|| edu.vt.middleware.ldap.derefAliases || _none_ || specifies how aliases should be handled; must be one of 'always', 'never', 'finding', or 'searching' ||
|| edu.vt.middleware.ldap.binaryAttributes || _none_ || space delimited list of attributes which should be treated as binary; e.g. userSMIMECertificate jpegPhoto ||
|| edu.vt.middleware.ldap.saslAuthorizationId || _none_ || entity for which access control checks should be made if the authentication succeeds ||
|| edu.vt.middleware.ldap.saslRealm || _none_ || identifies the realm or domain from which the principal name should be chosen ||
|| edu.vt.middleware.ldap.typesOnly || false || only return attribute type names ||
|| edu.vt.middleware.ldap.ssl || false || whether SSL should be used for LDAP connections ||
|| edu.vt.middleware.ldap.tls || false || whether TLS should be used for LDAP connections ||

=== Search Properties ===
Properties used for connecting, binding, and searching.
|| *Property Name* || *Default Value* || *Description* ||
|| edu.vt.middleware.ldap.baseDn || _none_ || default base dn used for operations ||
|| edu.vt.middleware.ldap.bindDn || _none_ || dn to bind as before performing operations ||
|| edu.vt.middleware.ldap.bindCredential || _none_ || credential for the bind dn ||
|| edu.vt.middleware.ldap.authtype || simple || LDAP authentication mechanism; must be one of 'none', 'simple', 'strong', 'DIGEST-MD5', 'CRAM-MD5', 'GSSAPI', or 'EXTERNAL' ||
|| edu.vt.middleware.ldap.ignoreCase || true || whether to ignore case in attribute names ||
|| edu.vt.middleware.ldap.operationRetry || 1 || specifies the number of times an LDAP operation will be retried if a retry exception occurs ||
|| edu.vt.middleware.ldap.operationRetryWait || 0 || the amount of time in milliseconds that LDAP operations should wait before retrying ||
|| edu.vt.middleware.ldap.operationRetryBackoff || 0 || factor by which to multiply the operation retry wait time; this allows clients to progressively delay each retry ||
|| edu.vt.middleware.ldap.operationRetryExceptions || {!CommunicationException, !ServiceUnavailableException} || exception classes to retry operations on; supports a comma delimited list for multiple values ||
|| edu.vt.middleware.ldap.logCredentials || false || whether bind credentials should be logged; logging occurs at debug level ||
|| edu.vt.middleware.ldap.connectionHandler || !DefaultConnectionHandler || creates and closes LDAP connections. See [vtldapHandlers] ||
|| edu.vt.middleware.ldap.searchResultHandlers || {!FqdnSearchResultHandler} || performs post processing of results; supports a comma delimited list for multiple values. See [vtldapHandlers] ||
|| edu.vt.middleware.ldap.handlerIgnoreExceptions || {!LimitExceededException} || exception classes that should be ignored when processing result sets; supports a comma delimited list for multiple values ||
|| edu.vt.middleware.ldap.pagedResultsSize || 0 || value used when the !PagedResultsControl in invoked ||

=== !SearchControl Properties ===
Properties that map to: [http://java.sun.com/j2se/1.5.0/docs/api/javax/naming/directory/SearchControls.html javax.naming.directory.SearchControls]
|| *Property Name* || *Default Value* || *Description* ||
|| edu.vt.middleware.ldap.searchScope || SUBTREE (2) || specifies the scope of searches; must be one of OBJECT (0), ONELEVEL (1), or SUBTREE (2) ||
|| edu.vt.middleware.ldap.timeLimit || 0 || the amount of time in milliseconds that search operations will block; a value of 0 means blocking indefinitely ||
|| edu.vt.middleware.ldap.countLimit || 0 || the maximum number of entries that search operations will return; a value of 0 means return all results ||
|| edu.vt.middleware.ldap.derefLinkFlag || false || whether links will be dereferenced during the search ||
|| edu.vt.middleware.ldap.returningObjFlag || false || whether objects will be returned as part of the result ||

=== Authenticator Properties ===
Properties used specifically for authentication.
All the previous properties are inherited by the Authenticator and can be overridden as necessary.
|| *Property Name* || *Default Value* || *Description* ||
|| edu.vt.middleware.ldap.auth.userField || {uid} || LDAP attribute(s) which contain the user identifier to search on; supports a comma delimited list for multiple values ||
|| edu.vt.middleware.ldap.auth.userFilter || _none_ || LDAP filter to search for users. Mutually exclusive with the userField propery. ||
|| edu.vt.middleware.ldap.auth.userFilterArgs || _none_ || LDAP filter arguments for the userFilter property. The {0} argument is automatically populated with the supplied user value. Any arguments provided here will start at {1}. Supports a comma delimited list for multiple values ||
|| edu.vt.middleware.ldap.auth.constructDn || false || whether the authentication dn should be constructed or looked up in the LDAP; a constructed dn takes the form: userField=user,baseDn. Equivalent to setting dnResolver to !ConstructDnResolver.  ||
|| edu.vt.middleware.ldap.auth.allowMultipleDns || false || whether an exception should be thrown if multiple DNs are found when the user is searched for; default behavior is to throw a !NamingException  ||
|| edu.vt.middleware.ldap.auth.dnResolver || !SearchDnResolver || implementation used to resolve a user's DN ||
|| edu.vt.middleware.ldap.auth.subtreeSearch || false  || whether the authentication dn should be searched for over the entire base; default value is onelevel  ||
|| edu.vt.middleware.ldap.auth.authenticationHandler || !BindAuthenticationHandler || performs LDAP authentication, see [vtldapHandlers]. ||
|| edu.vt.middleware.ldap.auth.authenticationResultHandlers || _none_ || performs post processing of authentication results, see [vtldapHandlers]. Supports a comma delimited list for multiple values ||
|| edu.vt.middleware.ldap.auth.authorizationFilter || _none_ || ldap filter to use for performing authorization after successful authentication  ||
|| edu.vt.middleware.ldap.auth.authorizationFilterArgs || _none_ || LDAP filter arguments for the authorizationFilter property. Supports a comma delimited list for multiple values ||
|| edu.vt.middleware.ldap.auth.authorizationHandlers || _none_ || performs post processing of authorization once authentication has succeeded, see [vtldapHandlers]. Supports a comma delimited list for multiple values ||

----
= Scripts =
Script execution requirements vary by platform.  For the following platform-specific instructions, let VTLDAP_HOME be the location where the VT Ldap distribution was unpacked.

*Unix*
 # Ensure the java executable is on your path.
 # Ensure $VTLDAP_HOME/bin is on your path.
 # If you encounter classpath problems executing the scripts, export VTLDAP_HOME as a separate shell variable.  This is not necessary in most cases (e.g. Linux, OSX, FreeBSD).

== ldapsearch - Search Operations ==
Perform a subtree search for any entry containing 'mail=dfisher@vt.edu' and return the attributes givenName and sn in LDIF format.
{{{
ldapsearch -ldapUrl ldap://directory.vt.edu -base ou=People,dc=vt,dc=edu -query mail=dfisher@vt.edu givenName sn
}}}

== ldapauth - Authentication Operations ==
Authenticate a user using the 'mail' attribute. You will be prompted for username and credential. Note that your credential will be visible in your terminal.
{{{
ldapauth -ldapUrl ldap://authn.directory.vt.edu -base ou=People,dc=vt,dc=edu -tls true -userField mail
}}}