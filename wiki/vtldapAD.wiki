#labels java,jndi,activedirectory,ldap
#sidebar vtldapSidebar

<wiki:toc max_depth="2" />

= Windows Active Directory =
Active Directory provides a LDAPv3 compliant interface for performing operations. However users should be aware of several pitfalls that are unique to Active Directory. This document attempts to explain these pitfalls and how to overcome them when using the vt-ldap library.

== Referrals ==
JNDI provides three ways in which to handle LDAP referrals: 'ignore', 'follow', and 'throw'. The way in which you configure this setting will determine how your search operations behave. Note that Active Directory will typically use referrals for any search bases that access domain DNS objects at the root level. e.g. dc=mydomain,dc=org.

=== Ignoring Referrals ===
Set the property: _edu.vt.middleware.ldap.referral=ignore_<br/>
The is the default setting, if you don't specify a value this is the behavior you will experience. Using this value causes JNDI to invoke the [http://www.faqs.org/rfcs/rfc3296.html Manage Referral] LDAP control which provides a mechanism to tell the LDAP server to return referral entries as ordinary entries. Active Directory does not support this control which results in a {{{javax.naming.PartialResultException: Unprocessed Continuation Reference(s)}}} when the search results are read by the client if referrals were encountered. (Note that all other settings will not send the {{{Manage Referral}}} control.)<br/><br/>

  * to ignore the partial result exceptions you can set:
{{{
edu.vt.middleware.ldap.handlerIgnoreExceptions=javax.naming.LimitExceededException,javax.naming.PartialResultException
}}}
This will will instruct the search result handler to ignore exceptions of type {{{LimitExceededException}}} and {{{PartialResultException}}}.<br/>
However, this solution is *not* recommend as referrals and entries can be returned in any order and you may miss entries found after a referral.

=== Following Referrals ===
Set the property: _edu.vt.middleware.ldap.referral=follow_<br/>
If you are confident that all the referrals returned by the Active Directory can be followed you can use this setting. Note that referrals often contain hostnames other than the server that is being searched. The authentication credentials for the original connection must be valid for any hosts supplied by the referrals. In addition, these hostnames must be DNS resolvable and reachable in order for the search to be successful. {{{javax.naming.CommunicationException}}} and {{{java.net.UnknownHostException}}} are commonly encountered when following referrals.<br/><br/>

=== Throwing Referrals ===
Set the property: _edu.vt.middleware.ldap.referral=throw_<br/>
Using this option will result in a {{{com.sun.jndi.ldap.LdapReferralException: Continuation Reference}}} being thrown when the search results are read. However, using this option guarantees that all entries will be read before the first referral is encountered. This option exists to allow you to decide whether to follow or ignore each referral and you can do so in several ways.<br/><br/>

  * to ignore the referral exceptions you can set:
{{{
edu.vt.middleware.ldap.handlerIgnoreExceptions=javax.naming.LimitExceededException,javax.naming.ReferralException
}}}
This will will instruct the search result handler to ignore exceptions of type {{{LimitExceededException}}} and {{{ReferralException}}}.<br/> Since all the entries will be read before the first referral is encountered, this is an easy mechanism for ignoring referrals.<br/><br/>

If you would like to process each result separately and make custom decisions, you will need to implement a custom [vtldapHandlers search result handler].<br/><br/>

=== Global Catalog ===
The Global Catalog enables searching for Active Directory objects in any domain in the forest without the need for subordinate referrals.
Because the Global Catalog contains only a subset of the attributes of an object, this solution is viable only if the attributes requested for the search results are stored in the Global Catalog. (Note the GC is accessible on port 3268/3269, not the standard LDAP ports of 389/636.)

=== Conclusions ===
  * If you must follow referrals use 'follow' and work with your Active Directory administrator to ensure you have the appropriate access to follow all referrals.
  * If you can ignore referrals use 'throw' and set handlerIgnoreExceptions appropriately.
  * If you don't want to deal with referrals and your Global Catalog contains every attribute you need, use it.

=== Useful Links ===
  * [http://java.sun.com/products/jndi/tutorial/ldap/referral/jndi.html Referrals in JNDI]
  * [http://java.sun.com/products/jndi/tutorial/ldap/referral/throw.html Manually Following Referrals]

== Binary Attributes ==
Some attributes in the Active Directory may be binary and need to be declared as such when they are retrieved.<br/><br/>

To work around this issue you can set: 
{{{
edu.vt.middleware.ldap.binaryAttributes=objectSid objectGUID
}}}
This will allow you to properly retrieve these attributes as byte arrays.